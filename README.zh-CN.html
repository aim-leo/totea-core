<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>totea</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/totea-core/assets/css/0.styles.4a98494c.css" as="style"><link rel="preload" href="/totea-core/assets/js/app.b4fdf9f6.js" as="script"><link rel="preload" href="/totea-core/assets/js/2.164c4daf.js" as="script"><link rel="preload" href="/totea-core/assets/js/8.247d51a0.js" as="script"><link rel="prefetch" href="/totea-core/assets/js/3.ebd2cf1a.js"><link rel="prefetch" href="/totea-core/assets/js/4.7974d278.js"><link rel="prefetch" href="/totea-core/assets/js/5.fe76296e.js"><link rel="prefetch" href="/totea-core/assets/js/6.a3f0e1fc.js"><link rel="prefetch" href="/totea-core/assets/js/7.62bd49c4.js">
    <link rel="stylesheet" href="/totea-core/assets/css/0.styles.4a98494c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/totea-core/" class="home-link router-link-active"><!----> <span class="site-name">totea</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/totea-core/README.zh-CN.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/totea-core/" class="nav-link">
  English
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/aim-leo/totea-core/tree/master/example" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Examples
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/aim-leo/totea-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/totea-core/README.zh-CN.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/totea-core/" class="nav-link">
  English
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/aim-leo/totea-core/tree/master/example" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Examples
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/aim-leo/totea-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/totea-core/README.zh-CN.html#简介" class="sidebar-link">简介</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/totea-core/README.zh-CN.html#示例" class="sidebar-link">示例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/totea-core/README.zh-CN.html#最小的示例" class="sidebar-link">最小的示例</a></li><li class="sidebar-sub-header"><a href="/totea-core/README.zh-CN.html#定义路由" class="sidebar-link">定义路由</a></li><li class="sidebar-sub-header"><a href="/totea-core/README.zh-CN.html#使用中间件" class="sidebar-link">使用中间件</a></li><li class="sidebar-sub-header"><a href="/totea-core/README.zh-CN.html#参数校验" class="sidebar-link">参数校验</a></li><li class="sidebar-sub-header"><a href="/totea-core/README.zh-CN.html#子路由" class="sidebar-link">子路由</a></li></ul></li><li><a href="/totea-core/README.zh-CN.html#安装使用" class="sidebar-link">安装使用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/totea-core/README.zh-CN.html#api" class="sidebar-link">API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/totea-core/README.zh-CN.html#server" class="sidebar-link">Server</a></li><li class="sidebar-sub-header"><a href="/totea-core/README.zh-CN.html#toteaserver" class="sidebar-link">ToteaServer</a></li><li class="sidebar-sub-header"><a href="/totea-core/README.zh-CN.html#controller" class="sidebar-link">Controller</a></li><li class="sidebar-sub-header"><a href="/totea-core/README.zh-CN.html#toteacontroller" class="sidebar-link">ToteaController</a></li><li class="sidebar-sub-header"><a href="/totea-core/README.zh-CN.html#methods" class="sidebar-link">Methods</a></li><li class="sidebar-sub-header"><a href="/totea-core/README.zh-CN.html#paramters" class="sidebar-link">Paramters</a></li><li class="sidebar-sub-header"><a href="/totea-core/README.zh-CN.html#middleware" class="sidebar-link">Middleware</a></li></ul></li><li><a href="/totea-core/README.zh-CN.html#成功响应" class="sidebar-link">成功响应</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/totea-core/README.zh-CN.html#失败响应" class="sidebar-link">失败响应</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/totea-core/README.zh-CN.html#路由优先级" class="sidebar-link">路由优先级</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/totea-core/README.zh-CN.html#http状态码" class="sidebar-link">HTTP状态码</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/totea-core/README.zh-CN.html#html模板及静态目录" class="sidebar-link">HTML模板及静态目录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/totea-core/README.zh-CN.html#类似的框架" class="sidebar-link">类似的框架</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p align="center"><img width="320" src="/totea-core/logo.svg"></p> <h3 align="center">
  使用装饰器和javascript构建web服务
</h3> <br> <br> <br> <p>简体中文 | <a href="/totea-core/" class="router-link-active">English</a></p> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p><strong>totea</strong>是一个基于express的nodejs框架，使用装饰器来定义路由和中间件。特点概述:</p> <ul><li><strong>javascript</strong> : 现有的使用装饰器的框架都默认使用typescript，totea可以在javascript中使用，只需要引入<a href="https://babeljs.io/docs/en/babel-plugin-proposal-decorators" target="_blank" rel="noopener noreferrer">plugin-proposal-decorators<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li><strong>简单高效</strong> : totea提供了不到20个装饰器函数，却可以支持多种复杂使用场景；</li> <li><strong>易于整合</strong> : totea使用express作为web服务器，我们没有修改任何底层的逻辑，这意味着在express中能使用的方法和插件，也可以在totea中使用。</li></ul> <hr> <h2 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h2> <h3 id="最小的示例"><a href="#最小的示例" class="header-anchor">#</a> 最小的示例</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// the app will serve at localhost:3000</span>
</code></pre></div><h3 id="定义路由"><a href="#定义路由" class="header-anchor">#</a> 定义路由</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server， Get， Post<span class="token punctuation">,</span> Delete<span class="token punctuation">,</span> Put<span class="token punctuation">,</span> Patch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
	@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/root'</span><span class="token punctuation">)</span>
    <span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    
	@<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'/root'</span><span class="token punctuation">)</span>
    <span class="token function">postRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>

    @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">'/root'</span><span class="token punctuation">)</span>
    <span class="token function">deleteRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>

    @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token string">'/root'</span><span class="token punctuation">)</span>
    <span class="token function">patchRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>

    @<span class="token function">Put</span><span class="token punctuation">(</span><span class="token string">'/root'</span><span class="token punctuation">)</span>
    <span class="token function">putRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="使用中间件"><a href="#使用中间件" class="header-anchor">#</a> 使用中间件</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server， Get， Middleware <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">Middleware</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// 全局中间件</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'call global middleware'</span><span class="token punctuation">)</span>
	<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
	@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/root'</span><span class="token punctuation">)</span>
	@<span class="token function">Middleware</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// 私有的中间件</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'call specific middleware'</span><span class="token punctuation">)</span>
		<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="参数校验"><a href="#参数校验" class="header-anchor">#</a> 参数校验</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server， Get， Query <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
	@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/root'</span><span class="token punctuation">)</span>
	@<span class="token function">Query</span><span class="token punctuation">(</span><span class="token parameter">query</span> <span class="token operator">=&gt;</span> query<span class="token punctuation">.</span>id <span class="token operator">&amp;&amp;</span> quey<span class="token punctuation">.</span>id<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment">// 必须在req.query中包含id字段，长度为10，否则返回400</span>
    <span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/root&quot; -X GET</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:400,&quot;message&quot;:&quot;Bad Request&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/root?id=1&quot; -X GET</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:400,&quot;message&quot;:&quot;Bad Request&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/root?id=1234567890&quot; -X GET</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:200,&quot;message&quot;:&quot;OK&quot;, &quot;result&quot;: 1}</span>
</code></pre></div><h3 id="子路由"><a href="#子路由" class="header-anchor">#</a> 子路由</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server， Get， Query， Controller <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

<span class="token comment">// use controller define a sub-route</span>
@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'childRoute'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ChildController</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/address'</span><span class="token punctuation">)</span> <span class="token comment">// GET /child-route/address</span>
  <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'ok'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// then provide it to server</span>
@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	controller<span class="token operator">:</span> <span class="token punctuation">[</span>ChildController<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/child-route/address&quot; -X GET</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:200,&quot;message&quot;:&quot;OK&quot;, &quot;result&quot;: 'ok'}</span>
</code></pre></div><h2 id="安装使用"><a href="#安装使用" class="header-anchor">#</a> 安装使用</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 安装totea</span>
<span class="token function">npm</span> i @totea/core

<span class="token comment"># 安装配置babel</span>
<span class="token function">npm</span> i @babel/core @babel/node @babel/plugin-proposal-decorators

<span class="token comment"># 如果已经有babel配置，添加decorator插件</span>
<span class="token comment"># 若没有，在项目根目录新建babel配置文件，写入以下内容:</span>
module.exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins: <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">&quot;@babel/plugin-proposal-decorators&quot;</span>, <span class="token punctuation">{</span> legacy: <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>,
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment"># 使用babel-node运行调试你的代码</span>
npx babel-node index.js
</code></pre></div><h2 id="api"><a href="#api" class="header-anchor">#</a> API</h2> <h3 id="server"><a href="#server" class="header-anchor">#</a> Server</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="参数"><a href="#参数" class="header-anchor">#</a> 参数</h4> <p><strong>Server</strong>装饰器用于定义一个Web服务器，包含以下参数:</p> <ul><li><strong>port</strong> : 服务运行的端口，<code>integer</code>，默认3000，可接受的端口范围:1024-65535；</li> <li><strong>middleware</strong> : 全局中间件，<code>array&lt;function&gt;</code>，类型是包含一个或多个function的数组；</li> <li><strong>errorMiddleware</strong> : 全局错误处理中间件，<code>array&lt;function&gt;</code>，类型是包含一个或多个function的数组；</li> <li><strong>controller</strong> : 二级路由列表，<code>array&lt;Controller|controller&gt;</code>，可以提供Controller或者已经实例化后的controller数组；</li> <li><strong>onServe</strong> : 服务开始运行的钩子函数，<code>function</code>；</li> <li><strong>onClose</strong> : 服务结束运行的钩子函数，<code>function</code>；</li> <li><strong>onResponse</strong>:  请求响应前的回调函数，可以用于定制响应格式，<code>function</code>；</li> <li><strong>slience</strong> :  是否禁止打印log，<code>boolean</code>，默认false；</li> <li><strong>static</strong> :  定义静态文件目录，<code>string|{path: string, maxAge: integer}</code>，可以接受string类型，表示目录，或者一个obejct， 参数会自动传给express.static()</li> <li><strong>view</strong>:  定义视图渲染模板,
-path:  模板文件夹，<code>string</code>， eg: './views'
-engine:  模板引擎 ，<code>object</code>，提供的值需要包含<code>__express</code>属性， eg: require('pug')
-type:  模板引擎名称，<code>string</code>，eg: 'pug'</li></ul> <h4 id="example"><a href="#example" class="header-anchor">#</a> example</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server， Get， Query， Controller <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'childRouteA'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ChildControllerA</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'childRouteB'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ChildControllerB</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  port<span class="token operator">:</span> <span class="token number">4000</span><span class="token punctuation">,</span>
  <span class="token function">onServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service is start success'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service is closed'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  errorMiddleware<span class="token operator">:</span> <span class="token punctuation">[</span>
	  <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'got a error'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
		<span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
	  <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  middleware<span class="token operator">:</span> <span class="token punctuation">[</span>
	<span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'call global middleware'</span><span class="token punctuation">)</span>
		<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controller<span class="token operator">:</span> <span class="token punctuation">[</span>
	ChildControllerA<span class="token punctuation">,</span>
	ChildControllerB
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token keyword">static</span><span class="token operator">:</span> <span class="token string">'./public'</span><span class="token punctuation">,</span>
  view<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'./views'</span><span class="token punctuation">,</span>
    engine<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pug'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">'pug'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  slience<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 你也可以在实例化的时候传参，这里的参数会合并覆盖已经在装饰器中传的部分</span>
<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	slience<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="toteaserver"><a href="#toteaserver" class="header-anchor">#</a> ToteaServer</h3> <p><strong>ToteaServer</strong> 经过Server装饰器包装后得到的类，也可以直接从totea中引用：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> ToteaServer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToteaServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 上面的例子等同于</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Server <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ToteaServer</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToteaServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="实例属性"><a href="#实例属性" class="header-anchor">#</a> 实例属性</h4> <ul><li><strong>app</strong> : 创建的express实例；</li> <li><strong>server</strong> : 创建的http server；</li> <li><strong>runing</strong>: 获取当前服务运行状态，true表示正在运行；</li></ul> <h4 id="实例方法"><a href="#实例方法" class="header-anchor">#</a> 实例方法</h4> <ul><li><strong>start()</strong> : 开始运行server；</li> <li><strong>stop()</strong> : 停止运行server；</li> <li><strong>status()</strong>: 获取当前服务运行状态，true表示正在运行；</li> <li><strong>useController(<code>Controller|controller</code>)</strong> : 注入二级路由，可以提供Controller或者已经实例化后的controller；</li> <li><strong>use()</strong> : 等同于express中的app.use；</li> <li><strong>all()</strong>: 等同于express中的app.all；</li> <li><strong>get()</strong> :等同于express中的app.get；</li> <li><strong>post()</strong>: 等同于express中的app.post；</li> <li><strong>patch()</strong> : 等同于express中的app.patch；</li> <li><strong>delete()</strong>: 等同于express中的app.delete；</li> <li><strong>put()</strong> : 等同于express中的app.put；</li></ul> <h3 id="controller"><a href="#controller" class="header-anchor">#</a> Controller</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Controller <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="参数-2"><a href="#参数-2" class="header-anchor">#</a> 参数</h4> <p><strong>Controller</strong> 装饰器用于定义二级路由，包含以下参数：</p> <ul><li><p><strong>name</strong> :  controller名称，<code>string</code>，不可包含<code>/</code>字符，我们默认会使用<a href="https://www.npmjs.com/package/humps" target="_blank" rel="noopener noreferrer">humps<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>对名称进行格式化，转换为驼峰格式，绑定的路由路径将转换为小写字符，并用-相连</p> <table><thead><tr><th style="text-align:left;">Input</th> <th style="text-align:center;">Name(<code>camelize</code>)</th> <th style="text-align:right;">Path(<code>decamelize, separator: -</code>)</th></tr></thead> <tbody><tr><td style="text-align:left;">@Controller(''hello-world_route')</td> <td style="text-align:center;">helloWorldRoute</td> <td style="text-align:right;">/hello-world-route</td></tr> <tr><td style="text-align:left;">@Controller(''Phone')</td> <td style="text-align:center;">phone</td> <td style="text-align:right;">/phone</td></tr> <tr><td style="text-align:left;">@Controller('/SubRoute')</td> <td style="text-align:center;">subRoute</td> <td style="text-align:right;">/sub-route</td></tr></tbody></table></li></ul> <h4 id="example-2"><a href="#example-2" class="header-anchor">#</a> example</h4> <p>下面这个例子演示了如何通过<code>this.controllers.${controllerName}</code>的方式在server或者每个controller中获取控制器实例，另外，在每个 controller 中可以通过<code>this.server</code>获取到server实例，这样极大的方便了代码复用：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server<span class="token punctuation">,</span> Controller<span class="token punctuation">,</span> Get <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../index'</span><span class="token punctuation">)</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'childOne'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ChildOneController</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/address'</span><span class="token punctuation">)</span> <span class="token comment">// GET /child-one/address</span>
  <span class="token function">getAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'childOne'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'child-two'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ChildTwoController</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/address'</span><span class="token punctuation">)</span> <span class="token comment">// GET /child-two/address</span>
  <span class="token function">getAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// run other controller's method</span>
    <span class="token keyword">const</span> childOneRes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>controllers<span class="token punctuation">.</span>childOne<span class="token punctuation">.</span><span class="token function">getAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// run root server's method</span>
    <span class="token keyword">const</span> rootRes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">getRootAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> rootRes <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> childOneRes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  controller<span class="token operator">:</span> <span class="token punctuation">[</span>ChildOneController<span class="token punctuation">,</span> ChildTwoController<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// GET /root</span>
  <span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'get/'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>controllers<span class="token punctuation">.</span>childTwo<span class="token punctuation">.</span><span class="token function">getAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">getRootAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'root'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/root&quot;</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:200,&quot;result&quot;:&quot;get/root/childOne&quot;,&quot;message&quot;:&quot;OK&quot;}</span>

</code></pre></div><h3 id="toteacontroller"><a href="#toteacontroller" class="header-anchor">#</a> ToteaController</h3> <p><strong>ToteaController</strong> 经过Controller装饰器包装后得到的类，也可以直接从totea中引用：</p> <p>不使用装饰器的写法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> <span class="token punctuation">{</span> ToteaServer<span class="token punctuation">,</span> ToteaController <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToteaController</span><span class="token punctuation">(</span><span class="token string">'child'</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToteaServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    controller<span class="token operator">:</span> <span class="token punctuation">[</span>controller<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>上面的例子等同于</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">const</span> <span class="token punctuation">{</span> Server， Controller <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

  @<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'child'</span><span class="token punctuation">)</span>
  <span class="token keyword">class</span> <span class="token class-name">ToteaController</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">class</span> <span class="token class-name">ToteaServer</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToteaServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    controller<span class="token operator">:</span> <span class="token punctuation">[</span>ToteaController<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="实例属性-2"><a href="#实例属性-2" class="header-anchor">#</a> 实例属性</h4> <ul><li><strong>router</strong> : 该controller创建的Router实例；</li> <li><strong>url</strong> : 该controller绑定的url地址；</li> <li><strong>name</strong>: 该controller的名称；</li></ul> <h4 id="实例方法-2"><a href="#实例方法-2" class="header-anchor">#</a> 实例方法</h4> <ul><li><strong>getRouter()</strong> : 返回该controller创建的Router实例；</li> <li><strong>use()</strong> : 等同于该控制器的router.use；</li> <li><strong>all()</strong>: 等同于该控制器的router.all；</li> <li><strong>get()</strong> :等同于该控制器的router.get；</li> <li><strong>post()</strong>: 等同于该控制器的router.post；</li> <li><strong>patch()</strong> : 等同于该控制器的router.patch；</li> <li><strong>delete()</strong>: 等同于该控制器的router.delete；</li> <li><strong>put()</strong> : 等同于该控制器的router.put；</li></ul> <blockquote><p>由此可见Server装饰器其实也是一种Controler装饰器，它们具有基本一样的方法，区别是Server中，调用<code>use | all | get</code>等方法，会把路由绑定到app，而在controller中，是绑定到内部的router中。而在express中，app本来就是一个特殊的router，不是吗？</p></blockquote> <p>阅读接下来的文档你可以发现，totea中的概念非常简单，它提供了基本一致的api以及尽量少的装饰器方法，对于开发者来说，非常容易掌握。</p> <h3 id="methods"><a href="#methods" class="header-anchor">#</a> Methods</h3> <p><strong>Methods</strong> 装饰器用于给Server或者Controller添加路由绑定，包含以下几个 ：</p> <ul><li><strong>Get</strong>: 绑定get请求</li> <li><strong>Post</strong>: 绑定postt请求</li> <li><strong>Delete</strong>: 绑定delete请求</li> <li><strong>Patch</strong>: 绑定patch请求</li> <li><strong>Put</strong>: 绑定put请求</li></ul> <p>参数： 表示绑定的路由地址，与 express中的地址一样，<code>string|regexp</code>，支持字符串或者正则表达式,可选，如果省略参数，则使用绑定的函数名称作为地址。</p> <h4 id="错误的例子"><a href="#错误的例子" class="header-anchor">#</a> 错误的例子</h4> <blockquote><p>注意：同一个url和method不可以绑定给不同的函数，不同的url也不能绑定到同一个函数，它们必须时一一对应的，totea可以校验大部分的错误场景，但是有一些需要开发者从编码上去规范。</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code>@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'leo'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>  <span class="token comment">// ERROR, can not bind /user again</span>
  <span class="token function">getUser2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'tony'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// will get a Error</span>
Error<span class="token operator">:</span> the url<span class="token operator">:</span> <span class="token operator">/</span>user has already bound
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code>@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'leo'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user2'</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// ERROR, can not bind /user2 to getUser</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'tony'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// will get a Error</span>
Error<span class="token operator">:</span> the callback<span class="token operator">:</span>getUser has already bound to url<span class="token operator">:</span> <span class="token operator">/</span>user<span class="token punctuation">,</span> method<span class="token operator">:</span> get
</code></pre></div><h4 id="应当避免的情况"><a href="#应当避免的情况" class="header-anchor">#</a> 应当避免的情况</h4> <blockquote><p>下面这个示例将不会报错，在同一个class中定义两个相同的方法似乎不是错的，但我们非常不建议这么做，这会使得代码逻辑非常混乱。</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code>@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'leo'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// RIGHT, but not recommand</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'tony'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="restful"><a href="#restful" class="header-anchor">#</a> RESTful</h4> <blockquote><p>同一个url可以绑定给不同的函数，前提是使用不同的方法，比如@Get('/user') @Post('/user')可以分别绑定给不同方法，这常用于创建RESTful风格的api。</p></blockquote> <p>下面这个示例演示了使用totea创建restful风格的api接口：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Delete<span class="token punctuation">,</span> Put <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

<span class="token comment">// mock db</span>
<span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// eg { id: 1, name: 'leo' }</span>
<span class="token comment">// mock user.id self increasing</span>
<span class="token keyword">let</span> lastCreateUserId <span class="token operator">=</span> <span class="token number">0</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> users
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">)</span>
  <span class="token function">getUserById</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> params <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'please input user id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>id <span class="token operator">===</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'this user is unexsist, please recheck'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> user
  <span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
  <span class="token function">insertUser</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> body <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>body<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'please input a user name'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>name <span class="token operator">===</span> body<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'this user is created, please recheck'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// insert to db</span>
    lastCreateUserId<span class="token operator">++</span>
    <span class="token keyword">const</span> insertItem <span class="token operator">=</span> <span class="token punctuation">{</span>
      id<span class="token operator">:</span> lastCreateUserId<span class="token punctuation">,</span>
      name<span class="token operator">:</span> body<span class="token punctuation">.</span>name
    <span class="token punctuation">}</span>
    users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>insertItem<span class="token punctuation">)</span>

    <span class="token keyword">return</span> insertItem
  <span class="token punctuation">}</span>

  @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">)</span>
  <span class="token function">deleteUserById</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> params <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'please input user id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> userIndex <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>userIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'this user is unexsist, please recheck'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//delete</span>
    <span class="token keyword">const</span> deleteItem <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>userIndex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> deleteItem
  <span class="token punctuation">}</span>

  @<span class="token function">Put</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">)</span>
  <span class="token function">modifyUserById</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> params<span class="token punctuation">,</span> body <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'please input user id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> userIndex <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>userIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'this user is unexsist, please recheck'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>body<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'please input a user name'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// update</span>
    <span class="token keyword">const</span> updateItem <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>users<span class="token punctuation">[</span>userIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> body<span class="token punctuation">.</span>name
    <span class="token punctuation">}</span>
    users<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>userIndex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> updateItem<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> updateItem
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/user&quot; -X GET</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:200,&quot;result&quot;:[],&quot;message&quot;:&quot;OK&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/user/1&quot; -X GET</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:400,&quot;message&quot;:&quot;this user is unexsist, please recheck&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/user&quot; -X POST</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:400,&quot;message&quot;:&quot;please input a user name&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/user&quot; -X POST -H &quot;Content-type: application/json&quot; -d '{&quot;name&quot;: &quot;leo&quot;}'</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:200,&quot;result&quot;:{&quot;id&quot;:1,&quot;name&quot;:&quot;leo&quot;},&quot;message&quot;:&quot;OK&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/user&quot; -X POST -H &quot;Content-type: application/json&quot; -d '{&quot;name&quot;: &quot;leo&quot;}'</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:400,&quot;message&quot;:&quot;this user is created, please recheck&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/user&quot; -X POST -H &quot;Content-type: application/json&quot; -d '{&quot;name&quot;: &quot;tony&quot;}'</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:200,&quot;result&quot;:{&quot;id&quot;:2,&quot;name&quot;:&quot;tony&quot;},&quot;message&quot;:&quot;OK&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/user&quot; -X GET</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:200,&quot;result&quot;:[{&quot;id&quot;:1,&quot;name&quot;:&quot;leo&quot;},{&quot;id&quot;:2,&quot;name&quot;:&quot;tony&quot;}],&quot;message&quot;:&quot;OK&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/user/1&quot; -X GET</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:200,&quot;result&quot;:{&quot;id&quot;:1,&quot;name&quot;:&quot;leo&quot;},&quot;message&quot;:&quot;OK&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/user/1&quot; -X DELETE</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:200,&quot;result&quot;:{&quot;id&quot;:1,&quot;name&quot;:&quot;leo&quot;},&quot;message&quot;:&quot;OK&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/user/1&quot; -X GET</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:400,&quot;message&quot;:&quot;this user is unexsist, please recheck&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/user/2&quot; -X PUT -H &quot;Content-type: application/json&quot; -d '{&quot;name&quot;: &quot;tom&quot;}'</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:200,&quot;result&quot;:{&quot;id&quot;:2,&quot;name&quot;:&quot;tom&quot;},&quot;message&quot;:&quot;OK&quot;}</span>

<span class="token comment">// &gt;&gt;&gt;&gt;&gt; curl &quot;localhost:3000/user&quot; -X GET</span>
<span class="token comment">// &lt;&lt;&lt;&lt;&lt; {&quot;status&quot;:200,&quot;result&quot;:[{&quot;id&quot;:2,&quot;name&quot;:&quot;tom&quot;}],&quot;message&quot;:&quot;OK&quot;}</span>
</code></pre></div><h4 id="绑定后的方法"><a href="#绑定后的方法" class="header-anchor">#</a> 绑定后的方法</h4> <p>当该方法被绑定到指定的路由，对应的请求将会由该方法来负责响应，每个请求的上下文将通过参数的形式注入。所有的参数：</p> <ul><li><strong>req</strong>: context.req</li> <li><strong>res</strong>: context.res</li> <li><strong>next</strong>: context.next</li> <li><strong>query</strong>: context.req.query</li> <li><strong>body</strong>: context.req.body</li> <li><strong>headers</strong>: context.req.headers</li> <li><strong>params</strong>: context.req.params
所有的参数将会注入到一个context 对象中，并注入到方法的第一个参数。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'/all_arg'</span><span class="token punctuation">)</span>
  <span class="token function">getData</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> res<span class="token punctuation">,</span> req<span class="token punctuation">,</span> next<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> query<span class="token punctuation">,</span> body<span class="token punctuation">,</span> params  <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// response with res.json</span>
	res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'OK'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="paramters"><a href="#paramters" class="header-anchor">#</a> Paramters</h3> <p><strong>Paramters</strong> 装饰器用于给请求添加参数过滤器，包含以下几个 ：</p> <ul><li><strong>Body</strong> body过滤器</li> <li><strong>Query</strong> query过滤器</li> <li><strong>Params</strong> params过滤器</li> <li><strong>Headers</strong> headers过滤器</li></ul> <h4 id="校验器"><a href="#校验器" class="header-anchor">#</a> 校验器</h4> <p>第一个参数表示校验器，<code>必填</code>，支持以下几种类型：</p> <ul><li><code>function</code> 参数是对应的请求内容,请看示例：</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Query<span class="token punctuation">,</span> Body <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Query</span><span class="token punctuation">(</span><span class="token parameter">query</span> <span class="token operator">=&gt;</span> query<span class="token punctuation">.</span>id <span class="token operator">&amp;&amp;</span> query<span class="token punctuation">.</span>id<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment">// 当req.query.id存在且长度为10时，返回true，表示校验通过, 不通过将收到{status: 400, message: &quot;Bad Request&quot;}</span>
  @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token parameter">body</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// 返回字符串格式，表示错误信息,将收到{status: 400, message: &quot;please provide a name&quot;}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>body<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'please provide a name'</span>
	<span class="token comment">// 没有返回或者返回true，表示检验通过</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">Params</span><span class="token punctuation">(</span><span class="token parameter">params</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回Error，表示http error 将收到{status: 400, message: error.message&quot;}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>params<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">Headers</span><span class="token punctuation">(</span><span class="token parameter">headers</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// 返回数字格式，表示http error status, 将收到{status: 401, message: &quot;Unauthorized&quot;}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headers<span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">401</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>tegund.ObjectT</code> 由<a href="https://www.npmjs.com/package/tegund" target="_blank" rel="noopener noreferrer">tegund<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>创建的object</li></ul> <p>totea中大量使用了tegund作为动态参数校验工具，它在常规的请求参数校验中同样非常有用。</p> <p>另外，totea框架本身依赖于tegund，这意味着你不用另外安装，可以直接引用，请看示例：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> object<span class="token punctuation">,</span> string<span class="token punctuation">,</span> integer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tegund'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Server<span class="token punctuation">,</span> Body<span class="token punctuation">,</span> Query<span class="token punctuation">,</span> Body <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Body</span><span class="token punctuation">(</span>
	<span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		name<span class="token operator">:</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// req.body.name 必须是字符串，且长度在2-10</span>
		age<span class="token operator">:</span> <span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//  req.body.age 必须是一个非负整数</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>tegund将会校验参数，在校验失败时返回对应的错误信息，你只需要提供合适的校验器。</p> <p>甚至还可以省略object，直接：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
  @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	name<span class="token operator">:</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	age<span class="token operator">:</span> <span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>对于更简单的情形，甚至可以这样：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
  @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	name<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
	age<span class="token operator">:</span> <span class="token string">'integer'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>更多的内容，请参阅<a href="https://www.npmjs.com/package/tegund" target="_blank" rel="noopener noreferrer">tegund说明文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="默认错误信息"><a href="#默认错误信息" class="header-anchor">#</a> 默认错误信息</h4> <p>第二个参数用于指定一个默认的错误信息，<code>选填</code>，<code>string</code>类型</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Query<span class="token punctuation">,</span> Body <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 不通过将收到{status: 400, message: &quot;expected a string id, length = 10&quot;}</span>
  @<span class="token function">Query</span><span class="token punctuation">(</span><span class="token parameter">query</span> <span class="token operator">=&gt;</span> query<span class="token punctuation">.</span>id <span class="token operator">&amp;&amp;</span> query<span class="token punctuation">.</span>id<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">&quot;expected a string id, length = 10&quot;</span><span class="token punctuation">)</span>
  <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>错误信息的<code>优先级</code>是 校验器返回的错误信息 &gt; 第二个参数指定的默认错误信息 &gt; 对应httpError(没有特别指定的情况是400)的错误信息。</p> <p>源代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// result 表示校验器的返回值 errorMessage表示提供的默认错误信息</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token function">createHttpError</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> errorMessage<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token function">createHttpError</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>message <span class="token operator">||</span> errorMessage<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> result <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token function">createHttpError</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> result <span class="token operator">||</span> errorMessage<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> result <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token function">createHttpError</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> errorMessage<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="middleware"><a href="#middleware" class="header-anchor">#</a> Middleware</h3> <p><strong>Middleware</strong> 装饰器用于给Server和Controller添加全局中间件，或者给某个请求添加单独的中间件。</p> <blockquote><p>中间件是express的核心，这在totea中同样重要，你可能发现了，上面讲到的Paramters参数校验器其实也是一种特殊的中间件，不是吗？</p></blockquote> <h4 id="全局中间件"><a href="#全局中间件" class="header-anchor">#</a> 全局中间件</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server<span class="token punctuation">,</span> Middleware <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">Middleware</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> req<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// 第一个全局中间件</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'call first global middleware of service'</span><span class="token punctuation">)</span>
	<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
@<span class="token function">Middleware</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> req<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 再添加一个全局中间件，该中间件将会在第一个中间件执行完后执行</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'call second global middleware of service'</span><span class="token punctuation">)</span>
	<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ToteaServer</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>同样可以为 controller添加：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Middleware <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'child'</span><span class="token punctuation">)</span>
@<span class="token function">Middleware</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> req<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// 第一个子路由全局中间件</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'call first global middleware of service'</span><span class="token punctuation">)</span>
	<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
@<span class="token function">Middleware</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> req<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 再添加一个子路由全局中间件，该中间件将会在第一个中间件执行完后执行</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'call second global middleware of service'</span><span class="token punctuation">)</span>
	<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ChildController</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h4 id="私有中间件"><a href="#私有中间件" class="header-anchor">#</a> 私有中间件</h4> <p>你可以给某个单独的路由添加私有中间件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server<span class="token punctuation">,</span> Middleware <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ToteaServer</span><span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
  @<span class="token function">Middleware</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> req<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// 第一个私有中间件</span>
	  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'call first middleware of /user'</span><span class="token punctuation">)</span>
	  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">Middleware</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> req<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 再添加一个私有中间件，该中间件将会在第一个中间件执行完后执行</span>
	  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'call second middleware of /user'</span><span class="token punctuation">)</span>
	  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="使用express中间件"><a href="#使用express中间件" class="header-anchor">#</a> 使用Express中间件</h4> <p>我们说过，totea使用express作为web服务器，我们没有修改任何底层的逻辑，这意味着可以直接使用所有针对Express开发的中间件</p> <p>示例，使用morgan来打印请求日志：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server<span class="token punctuation">,</span> Middleware <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> morgan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'morgan'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">Middleware</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">'combined'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ToteaServer</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h4 id="自带的日志中间件"><a href="#自带的日志中间件" class="header-anchor">#</a> 自带的日志中间件</h4> <p>当然，totea 也自带了一个简单的日志打印中间件，使用方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server<span class="token punctuation">,</span> Logger<span class="token punctuation">,</span> Get <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> morgan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'morgan'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span><span class="token punctuation">{</span>
	@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
	<span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">{</span>
			result<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">&quot;docs&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;page&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;limit&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			message<span class="token operator">:</span> <span class="token string">'user query success!'</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// logs</span>
<span class="token punctuation">[</span>totea logger<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">18.836</span>Z <span class="token operator">/</span>user <span class="token constant">GET</span> <span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">&quot;result&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;docs&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;page&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;limit&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;message&quot;</span><span class="token operator">:</span><span class="token string">&quot;user query success!&quot;</span><span class="token punctuation">}</span> <span class="token number">11</span>ms

<span class="token punctuation">[</span>totea logger<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span>T09<span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">07.921</span>Z <span class="token operator">/</span>user <span class="token constant">GET</span> <span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">&quot;result&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;docs&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;page&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;limit&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;message&quot;</span><span class="token operator">:</span><span class="token string">&quot;user query success!&quot;</span><span class="token punctuation">}</span> <span class="token number">3</span>ms

<span class="token punctuation">[</span>totea logger<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span>T09<span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">08.684</span>Z <span class="token operator">/</span>user <span class="token constant">GET</span> <span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">&quot;result&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;docs&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;page&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;limit&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;message&quot;</span><span class="token operator">:</span><span class="token string">&quot;user query success!&quot;</span><span class="token punctuation">}</span> <span class="token number">1</span>ms

<span class="token punctuation">[</span>totea logger<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span>T09<span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">09.346</span>Z <span class="token operator">/</span>user <span class="token constant">GET</span> <span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">&quot;result&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;docs&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;page&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;limit&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;message&quot;</span><span class="token operator">:</span><span class="token string">&quot;user query success!&quot;</span><span class="token punctuation">}</span> <span class="token number">1</span>ms
</code></pre></div><h2 id="成功响应"><a href="#成功响应" class="header-anchor">#</a> 成功响应</h2> <p>在express中，一般使用req.send 或者 res.json来响应请求，该方法在totea中也同样适用：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span><span class="token punctuation">{</span>
	@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
	<span class="token function">getUser</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> res <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">&quot;OK&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/page'</span><span class="token punctuation">)</span>
	<span class="token function">getPage</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> res <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;some html&lt;/p&gt;'</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
	@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/html'</span><span class="token punctuation">)</span>
	<span class="token function">getPage</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> res <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token string">'test.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> root<span class="token operator">:</span> <span class="token string">'pages'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在totea中，我们有更加便捷的方式来返回json，只需要把内容放在函数的返回值中。
除json以外的请求，仍然需要使用res的方法来响应。</p> <blockquote><p>注意，当函数没有返回值，或者返回undefined（在实际的代码中无法分辨），totea会视作请求为被正确响应，返回{ status: 500, message: &quot;Internal Server Error&quot; }</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code>@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span><span class="token punctuation">{</span>
	@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
	<span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 返回的内容将以{ status: 200, message: &quot;OK&quot;, result: ${return} }形式包裹</span>
		<span class="token keyword">return</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'leo'</span><span class="token punctuation">,</span> address<span class="token operator">:</span> <span class="token string">'XXX'</span> <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/json'</span><span class="token punctuation">)</span>
	<span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 假设返回的是一个obejct，且具有一个整数类型的status，或者有一个字符串格式非空的message，则返回该json</span>
		<span class="token keyword">return</span> <span class="token punctuation">{</span>
			status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
			result<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'leo'</span><span class="token punctuation">,</span> address<span class="token operator">:</span> <span class="token string">'XXX'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
			message<span class="token operator">:</span> <span class="token string">'OK'</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 以上两个请求都将返回一样的内容：</span>
<span class="token punctuation">{</span>
	status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
	result<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'leo'</span><span class="token punctuation">,</span> address<span class="token operator">:</span> <span class="token string">'XXX'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
	message<span class="token operator">:</span> <span class="token string">'OK'</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>totea劫持了res的sendFile和send方法，以便在请求响应前，获取到预计要返回的内容。同时，我们也规避了重复响应请求的问题。</p></blockquote> <p>下面这个例子，当请求被res.json响应后，代码虽然会接着往下运行，但是不会再重复响应，当然，及时return是一个很好的编码习惯。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span><span class="token punctuation">{</span>
	@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
	<span class="token function">getUser</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> res<span class="token punctuation">,</span> query <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>query<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'please provide a user id'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'leo'</span><span class="token punctuation">,</span> address<span class="token operator">:</span> <span class="token string">'XXX'</span> <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="失败响应"><a href="#失败响应" class="header-anchor">#</a> 失败响应</h2> <p>相比成功的响应，在实际编码中，接口返回错误的情形要更为普遍，totea提供了多种方式来处理：</p> <blockquote><p>totea中使用<a href="https://www.npmjs.com/package/http-errors" target="_blank" rel="noopener noreferrer">http-errors<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来创建httpError，你可以直接引入该库，或者直接使用createHttpError方法。</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> createHttpError <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>
@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  <span class="token comment">// response by res, got: {&quot;status&quot;:401,&quot;message&quot;:&quot;Unauthorized&quot;}</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/error_res'</span><span class="token punctuation">)</span>
  <span class="token function">errorRes</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> res <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'Unauthorized'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// return a Promise.reject， with a http status, got: {&quot;status&quot;:404,&quot;message&quot;:&quot;Not Found&quot;}</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/error_status'</span><span class="token punctuation">)</span>
  <span class="token function">errorstatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// return a Promise.reject, with a error message, got: {&quot;status&quot;:400,&quot;message&quot;:&quot;this is the invalid message&quot;}</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/error_message'</span><span class="token punctuation">)</span>
  <span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'this is the invalid message'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// return a Promise.reject, with http status and message, got: {&quot;status&quot;:410,&quot;message&quot;:&quot;this is the invalid message&quot;}</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/error_status_message'</span><span class="token punctuation">)</span>
  <span class="token function">errorstatusAndMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      status<span class="token operator">:</span> <span class="token number">410</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">'this is the invalid message'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// return a http error, got: {&quot;status&quot;:401,&quot;message&quot;:&quot;Unauthorized&quot;}</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/http_error'</span><span class="token punctuation">)</span>
  <span class="token function">httpError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createHttpError</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// throw a http error, got: {&quot;status&quot;:401,&quot;message&quot;:&quot;Unauthorized&quot;}</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/http_error'</span><span class="token punctuation">)</span>
  <span class="token function">throwHttpError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token function">createHttpError</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// return a normal error, got {&quot;status&quot;:406,&quot;message&quot;:&quot;this is a error message&quot;}</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/return_simple_error'</span><span class="token punctuation">)</span>
  <span class="token function">returnSimpleError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'this is a error message'</span><span class="token punctuation">)</span>

    e<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">406</span>

    <span class="token keyword">return</span> e
  <span class="token punctuation">}</span>

  <span class="token comment">// throw a normal error, got {&quot;status&quot;:406,&quot;message&quot;:&quot;this is a error message&quot;}</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/throw_simple_error'</span><span class="token punctuation">)</span>
  <span class="token function">throwSimpleError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'this is a error message'</span><span class="token punctuation">)</span>

    e<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">406</span>

    <span class="token keyword">throw</span> e
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Express并没有提供全局错误处理的方法，对于截获async/await抛出的异常尤为困难，totea默认使用<a href="https://www.npmjs.com/package/express-async-errors" target="_blank" rel="noopener noreferrer">express-async-errors<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，当截获未知错误时，始终返回一个{ status: 500, message: &quot;Internal Server Error&quot; }。</p></blockquote> <h2 id="路由优先级"><a href="#路由优先级" class="header-anchor">#</a> 路由优先级</h2> <p>express 本身未提供路由优先级排序，路由的顺序决定于你的代码顺序。当使用express原生的方法来定义路由时，你的app可能存在不可触达的死区：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// 所有的请求都在这里被响应了</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// 死区</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token operator">:</span> <span class="token string">'leo'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><p>这与我们预期的情况不符，我们希望具体路由先匹配，其次才是匹配式路由。</p> <p>在totea中完全不需要担心这种情况，我们默认使用<a href="https://www.npmjs.com/package/sort-route-addresses" target="_blank" rel="noopener noreferrer">sort-route-addresses<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>对路由的优先级进行了排序：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Server<span class="token punctuation">,</span> Get <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@totea/core'</span><span class="token punctuation">)</span>

@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">)</span>
  <span class="token function">getUserById</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> res<span class="token punctuation">,</span> params <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> params<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> res <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token operator">:</span> <span class="token string">'leo'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

service<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>这个例子和上面完全一样，但是满足要求。</p> <h2 id="http状态码"><a href="#http状态码" class="header-anchor">#</a> HTTP状态码</h2> <p>totea的设计初衷心就是用于创建API服务器，用它来写接口将非常高效。</p> <p>在实际的开发过程中，我们的接口可能会被要求始终以200的状态码来返回数据，而实际的状态信息在返回的json中去体现。
例如，客户端开发工程师可能会要求你这样设计接口：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 当请求成功时</span>
Status status<span class="token operator">:</span> <span class="token number">200</span> <span class="token constant">OK</span>
response<span class="token operator">:</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">,</span> result<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'leo'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token comment">// 当请求出错时，比如权限不足</span>
Status status<span class="token operator">:</span> <span class="token number">200</span> <span class="token constant">OK</span>
response<span class="token operator">:</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">&quot;Unauthorized&quot;</span> <span class="token punctuation">}</span>
</code></pre></div><p>这不得不说也是一种规范，但和主流的设计思想相悖，例如RESTful：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 当请求成功时</span>
Status status<span class="token operator">:</span> <span class="token number">200</span> <span class="token constant">OK</span>
response<span class="token operator">:</span> <span class="token punctuation">{</span> result<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'leo'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token comment">// 当请求出错时，比如权限不足</span>
Status status<span class="token operator">:</span> <span class="token number">401</span> Unauthorized
response<span class="token operator">:</span> <span class="token keyword">null</span>
</code></pre></div><p>关于这个问题在V2EX上有过激烈的讨论，原文地址： <a href="https://www.v2ex.com/t/191534" target="_blank" rel="noopener noreferrer">API 使用 HTTP 状态码还是全部返回 200<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, 每个开发者都有不同的理解</p> <p>totea默认使用第一种规范，但是允许开发者自定义响应，Server装饰器接受一个onResponse方法，该方法会在每次请求被返回前被调用，你可以提供一个自定义的方法去覆盖它。</p> <p>默认的onResponse方法是：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> res<span class="token punctuation">,</span> status<span class="token punctuation">,</span> result<span class="token punctuation">,</span> message <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
     <span class="token function">removeEmpty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  <span class="token comment">// if some arg is undefined, will remove it</span>
       status<span class="token operator">:</span> status<span class="token punctuation">,</span>
       message<span class="token operator">:</span> message<span class="token punctuation">,</span>
       result
     <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
		removeNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
		removeUndefined<span class="token operator">:</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>假设你想使用RESTful的规范：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>@<span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	<span class="token function-variable function">onResponse</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> res<span class="token punctuation">,</span> status<span class="token punctuation">,</span> result<span class="token punctuation">,</span> message <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span>
		res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> result<span class="token punctuation">,</span> message <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="html模板及静态目录"><a href="#html模板及静态目录" class="header-anchor">#</a> HTML模板及静态目录</h2> <p>详细的例子请查看<a href="https://github.com/aim-leo/totea-core/tree/master/example/view" target="_blank" rel="noopener noreferrer">地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="类似的框架"><a href="#类似的框架" class="header-anchor">#</a> 类似的框架</h2> <ul><li><code>nestjs</code> <a href="https://www.npmjs.com/package/@nestjs/core" target="_blank" rel="noopener noreferrer">链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> nestjs是一个大而全的框架，设计思想非常优秀。需要搭配typescript来使用，适合开发大型项目。</li> <li><code>overnightjs</code><a href="https://www.npmjs.com/package/@overnightjs/core" target="_blank" rel="noopener noreferrer">链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> overnightjs的设计思路与totea较为相似，区别是它需要搭配typescript来使用。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/totea-core/assets/js/app.b4fdf9f6.js" defer></script><script src="/totea-core/assets/js/2.164c4daf.js" defer></script><script src="/totea-core/assets/js/8.247d51a0.js" defer></script>
  </body>
</html>
